# UAV Network Simulator Progress — 2024-10-22 (Raw Capture + HTTP Collector)

## Objective
- Keep ns-3–driven middleware shaping PX4↔QGC traffic while capturing the exact MAVLink UDP packets as PCAPNG.
- Push 1 Hz JSON summaries (delay/loss/rate + up/down byte counts + drone telemetry) into the FastAPI collector so AI/RL agents can fetch merged observations with `/obs/latest` or `/obs/seq`.

## Newly Added Artifacts
| Path | Role |
| --- | --- |
| `~/uav_tools/reset_all.sh` | Stops PX4, MAVROS, middleware, collector, tcpdump; prints which UDP ports are still in use. |
| `~/uav_tools/start_capture.sh` | Launches tcpdump on `lo` (or a TAP interface) and writes `~/pcaps/<RUN_ID>.all.pcapng` plus a PID file. |
| `~/uav_tools/stop_capture.sh` | Terminates the matching tcpdump process by `RUN_ID`, syncing the PCAP to disk. |
| `~/uav_tools/pcap_to_csv.sh` | Uses `tshark` to convert a PCAPNG into a CSV (epoch time, src/dst, ports, frame len, payload hex). |
| `~/uav_tools/start_collector.sh` | Runs `collector.py` under `nohup`, tails `/obs/latest` once, and logs to `~/uav_logs/collector.log`. |
| `~/collector.py` | FastAPI server that accepts `/ingest` (middleware metrics) and `/ingest_extra` (ROS telemetry), and serves `/obs/latest`, `/obs/extra/latest`, `/obs/seq`. |
| `~/mw_ns3/ros_extra_pusher.py` | ROS node that watches MAVROS topics + `/mavlink/from`, derives Hz/heartbeat gaps, and POSTs extras every second. |
| `~/mw_ns3/udp_mw_ns3.py` | Middleware that relays PX4↔QGC, enforces ns-3 delay/loss/rate, logs to `~/.uav_ids/flow.jsonl`, and POSTs the same metrics via `IDS_ENDPOINT`. |

## Dependencies & Directory Layout
```bash
sudo apt-get update
sudo apt-get install -y tcpdump tshark python3-pip lsof netcat-openbsd
python3 -m pip install --user fastapi uvicorn pydantic requests pymavlink

mkdir -p ~/uav_tools ~/pcaps ~/pcap_csv ~/uav_logs ~/mw_ns3 ~/.uav_ids
Raw Packet Capture Flow
Reset everything

bash
코드 복사
~/uav_tools/reset_all.sh
Start capture

bash
코드 복사
export RUN_ID="run_test001"
IFACE=lo ~/uav_tools/start_capture.sh "$RUN_ID"
# For TAP, set IFACE=tap-<name>
Produces ~/pcaps/run_test001.all.pcapng, a tcpdump log, and a PID file.

Stop capture

bash
코드 복사
~/uav_tools/stop_capture.sh "$RUN_ID"
If RUN_ID is omitted it uses the newest PID file automatically.

Convert to CSV (optional features for ML)

bash
코드 복사
~/uav_tools/pcap_to_csv.sh "$RUN_ID"
# -> ~/pcap_csv/run_test001.basic.csv
JSON Push/Pull Flow
Collector (FastAPI + uvicorn)

bash
코드 복사
~/uav_tools/start_collector.sh
# logs: ~/uav_logs/collector.log
Endpoints:

POST /ingest – middleware sends {run_id, ts, up_bytes, down_bytes, delay_ms, loss_pct, rate_kbps} plus optional extras.

POST /ingest_extra – ROS sends {run_id, ts, altitude_m, groundspeed_mps, battery_pct, heading_deg, heartbeat_gap_ms, fix_type, eph, epv, satellites_used, jamming_indicator, hb_hz, status_hz, paramset_hz, cmdlong_hz, gpsint_hz}.

GET /obs/latest?k=N, GET /obs/extra/latest?k=N, GET /obs/seq?since_seq=...&limit=...&run_id=....

PX4 SITL

bash
코드 복사
cd ~/PX4-Autopilot
PX4_NO_FORK=1 make px4_sitl_default none_iris   # keep pxh> prompt open
ROS Core + MAVROS + altitude mirroring

bash
코드 복사
source /opt/ros/noetic/setup.bash
roscore &
rosrun mavros mavros_node _fcu_url:=udp://0.0.0.0:14556@127.0.0.1:14540 &
export NS3_PATH="$HOME/ns-allinone-3.35/ns-3.35"
~/mw_ns3/start_alt.sh &
ROS extra pusher

bash
코드 복사
export RUN_ID="run_test001"
export IDS_EXTRA_ENDPOINT="http://127.0.0.1:8080/ingest_extra"
source /opt/ros/noetic/setup.bash
python3 ~/mw_ns3/ros_extra_pusher.py &
ns-3 middleware

bash
코드 복사
export RUN_ID="run_test001"
export NS3_PATH="$HOME/ns-allinone-3.35/ns-3.35"
export IDS_ENDPOINT="http://127.0.0.1:8080/ingest"
~/mw_ns3/start_mw.sh
Console shows [MW] up:… down:… | delay=… loss=… rate=… plus HTTP POST successes.

QGroundControl

Disable UDP auto-listen on 14550.

Add a Comm Link: Server=127.0.0.1, Port=14640. (Optional: teach PX4 the partner by briefly adding 127.0.0.1:18570.)

Verification

bash
코드 복사
curl -s "http://127.0.0.1:8080/obs/latest?k=3" | python3 -m json.tool
curl -s "http://127.0.0.1:8080/obs/seq?since_seq=100&limit=10" | python3 -m json.tool
Validation Notes
/obs/latest now shows both link metrics (delay≈10 ms, loss≈0.5 %, rate≈6 Mbps, up/down byte counts) and flight telemetry (altitude, groundspeed, GNSS fix_type≈3, satellites≈10, hb_hz≈1, status_hz≈5, gpsint_hz≈50).

/obs/extra/latest mirrors MAVROS data every second, so merging is automatic when both producers share the same RUN_ID.

~/pcaps/run_test001.all.pcapng grows with MAVLink traffic; ~/pcap_csv/run_test001.basic.csv is ~50 columns wide and ready for feature extraction.

A 2 s “blackout” can be injected by writing 0 0 333 to positions.txt, yielding loss_pct≈100% and near-zero downlink bytes for that window.

Data Products
Artifact	Description
~/pcaps/<RUN_ID>.all.pcapng	Full MAVLink UDP capture suitable for Wireshark/tshark.
~/pcap_csv/<RUN_ID>.basic.csv	CSV export with timestamp, src/dst, ports, frame len, payload hex.
/obs/latest JSON	Per-second union of network metrics + drone telemetry (includes run_id, seq, node_id, delay/loss/rate, bytes, altitude, groundspeed, heading, heartbeat gap, GNSS quality, MAVLink Hz).
~/.uav_ids/flow.jsonl	Local copy of the same 1 Hz metrics from the middleware.

Troubleshooting
ModuleNotFoundError: fastapi → rerun the pip install command above.

MAVROS connected: False → ensure rosrun mavros mavros_node _fcu_url:=udp://0.0.0.0:14556@127.0.0.1:14540 matches PX4 ports.

positions.txt instantly reverts while editing → stop start_alt.sh (it overwrites every 1 Hz).

collector empty arrays → confirm RUN_ID, IDS_ENDPOINT, and IDS_EXTRA_ENDPOINT match.

Ports busy → ~/uav_tools/reset_all.sh + sudo lsof -nP -iUDP:14540,14550,14556,14558,14640.

Summary
By pairing tcpdump-based PCAP capture with the HTTP collector, every experiment now yields both raw traffic (forensics/features) and synchronized JSON observations (delay/loss/rate + drone state). AI/RL agents can fetch /obs/seq while analysts mine the CSV/PCAP for deeper anomalies.

Testing
Manual PX4 SITL + MAVROS + middleware stack, curl checks for /obs/latest & /obs/seq, tcpdump PCAP inspection (not run in this read-only QA session).

bash
코드 복사

---

## 2. Utility & Helper Scripts (copy each to the indicated path)

### `~/uav_tools/reset_all.sh`
```bash
#!/usr/bin/env bash
set -euo pipefail

echo "[kill] px4/qgc/mavros/middleware/collector/tcpdump …"
pkill -f 'px4_sitl_default/bin/px4|org.mavlink.qgroundcontrol|mavros|udp_mw_ns3.py|collector.py|ros_extra_pusher.py|uvicorn|alt2positions.py' 2>/dev/null || true
sudo pkill tcpdump 2>/dev/null || true

echo "[check UDP holders]"
sudo lsof -nP -iUDP:14540 -iUDP:14550 -iUDP:14556 -iUDP:14558 -iUDP:14640 || true
echo "done."
