
# UAV Network Simulator Progress — 2024-10-09 (NS-3 Build)

## Objective
- Replace the fixed-delay middleware from 10/08 with a closed loop that reacts to live altitude changes.
- ROS/MAVROS publishes the UAV’s relative altitude `h`; ns-3 converts `h` into delay/loss/rate metrics; the middleware applies those metrics to every MAVLink packet between QGC and PX4.

## Moving Parts
| Component | Role | Key Notes |
| --- | --- | --- |
| `mw_ns3/alt2positions.py` | “Reporter” that tails `/mavros/global_position/rel_alt` at 1 Hz and rewrites `positions.txt`. | Prevents stale data by clamping negative heights to zero and writing the file atomically every second. |
| `scratch/mw-link-metrics` (ns-3) | “Calculator” that reads `positions.txt`, computes delay/loss/rate, and prints them for downstream consumers. | Linear model with safety clipping: `delay ≤ 160 ms`, `loss ≤ 30 %`, `rate ≥ 300 kbps`. |
| `mw_ns3/udp_mw_ns3.py` | “Enforcer” middleware that binds UDP 14640 (QGC uplink) and 14550 (PX4 telemetry), injects impairment, and logs metrics. | Polls ns-3 every second, shapes traffic, and appends JSONL telemetry to `~/.uav_ids/flow.jsonl`. |
| `mw_ns3/start_mw.sh` | Launch helper that wires environment variables and starts the middleware with consistent arguments. | Keeps `NS3_PATH`, log directory, and ports in one place so tmux/supervisor sessions stay reproducible. |
| `~/.uav_ids/flow.jsonl` | Training/logging sink. | Stores one JSON record per second: timestamp, up/down byte counters, and the metrics that were applied in that interval. |

## “Chain of Command”
1. **Reporter (alt2positions.py)** — watches MAVROS altitude and immediately overwrites `positions.txt` whenever `h` changes.
2. **Calculator (ns-3 mw-link-metrics)** — re-reads `positions.txt` each second and outputs the channel metrics implied by the new height.
3. **Enforcer (udp_mw_ns3.py)** — consumes those metrics and actually delays/drops/throttles MAVLink packets between QGC and PX4.

## Real-Time Flow
1. PX4 SITL is launched (`make px4_sitl gazebo`) and exposes UDP 14540/14550.
2. MAVROS connects via `roslaunch mavros px4.launch fcu_url:=udp://:14540@` and republishes `/mavros/global_position/rel_alt`.
3. `alt2positions.py` records the latest altitude into `${NS3_PATH}/positions.txt`.
4. `mw-link-metrics` is invoked via `./waf --run 'scratch/mw-link-metrics'`, reads the altitude, and prints delay/loss/rate.
5. `udp_mw_ns3.py` (started through `start_mw.sh`) polls the ns-3 program every second, updates its shaping parameters, and relays packets:
   - QGC → UDP 14640 → middleware → PX4 UDP 14540.
   - PX4 UDP 14550 → middleware → QGC listen port 14550.

## Implementation Checklist
1. **Environment & permissions**
   ~~~bash
   export NS3_PATH="/home/ubuntu/ns-allinone-3.35/ns-3.35"
   echo "NS3_PATH=$NS3_PATH"
   ls -ld "$NS3_PATH"
   sudo chown -R "$USER":"$USER" "$NS3_PATH"
   ~~~
2. **Bring the stack online**
   1. `~/mw_ns3/start_mw.sh` — launches the middleware (polls ns-3 at 1 Hz and updates JSON logs).
   2. `cd ~/PX4-Autopilot && make px4_sitl gazebo` — starts the simulated UAV.
   3. QGC: disable auto-listen on 14550, then `Connect to host → 127.0.0.1:14640`.
   4. `roslaunch mavros px4.launch fcu_url:=udp://:14540@` — confirms `/mavros/state` shows `connected: True`.
   5. `python3 ~/mw_ns3/alt2positions.py` — writes altitude to `positions.txt` at 1 Hz.
   6. Verify middleware logs show non-zero `up`/`down` byte counters and ns-3-derived metrics.
3. **ns-3 sanity checks**
   ~~~bash
   cd "$NS3_PATH"
   ./waf --run 'scratch/mw-link-metrics'
   printf "0 0 0\n0 0 50\n" > "$NS3_PATH/positions.txt"
   cat "$NS3_PATH/positions.txt"
   ~~~
   Expect lines such as `DELAY_MS:60`, `LOSS_PCT:15`, `RATE_KBPS:4000` for `h = 50 m`.
4. **Middleware restart with ns-3 input**
   ~~~bash
   export NS3_PATH="/home/ubuntu/ns-allinone-3.35/ns-3.35"
   python3 ~/mw_ns3/udp_mw_ns3.py
   ~~~
   Within one second of writing `h = 50`, logs should display `delay≈60 ms`, `loss≈15 %`, `rate≈4000 kbps`.

## Validation & Observations
### Altitude sweep
| Altitude (m) | Delay (ms) | Loss (%) | Rate (kbps) | Notes |
| --- | --- | --- | --- | --- |
| 5 | 15 | 1.5 | 5800 | Baseline hover. |
| 30 | 40 | 9.0 | 4800 | Mid-altitude check. |
| 80 | 90 | 24.0 | 2800 | High-altitude but before clipping. |
| ≥150 | 160 | 30.0 | 300 | Model clamps to protect against runaway parameters. |

### On-takeoff checkpoints
- Lift-off (~1.7 m): middleware reports ≈11.7 ms, 0.5 % loss, 5930 kbps.
- At 50 m: ≈60 ms, 15 % loss, 4000 kbps.

### 2-second blackout drill
~~~bash
ALT_SAVE=$(awk 'NR==2{print $3}' "$NS3_PATH/positions.txt")
printf "0 0 0\n0 0 333\n" > "$NS3_PATH/positions.txt"
sleep 2
printf "0 0 0\n0 0 %s\n" "$ALT_SAVE" > "$NS3_PATH/positions.txt"
~~~
The telemetry stream freezes for ~2 s (loss≈100 %) and recovers automatically once the altitude reverts.

### Flow logging
`tail -n 5 ~/.uav_ids/flow.jsonl` shows one JSON record per second, e.g.:
~~~json
{"ts": 1759845000.12, "up_bytes": 145, "down_bytes": 1793, "delay_ms": 60.0, "loss_pct": 15.0, "rate_kbps": 4000.0}
~~~
These metrics can feed future analytics or ML workloads.

## Link-Quality Model
\[
\begin{aligned}
\text{delay}_{ms} &= \min(160,\ 10 + h) \\
\text{loss}_{\%} &= \min(30,\ 0.3 \times h) \\
\text{rate}_{kbps} &= \max(300,\ 6000 - 40 \times h)
\end{aligned}
\]
The middleware clamps each dimension to stay within the safe envelope, so even very high altitudes keep deterministic upper/lower bounds.

## Files Introduced
- `docs/uav-simulator/progress-2024-10-09.md` — this log.
- `mw_ns3/udp_mw_ns3.py` — ns-3 aware middleware.
- `mw_ns3/start_mw.sh` — helper to boot the middleware with the right parameters.
- `mw_ns3/alt2positions.py` — ROS bridge from MAVROS altitude to ns-3 `positions.txt`.
- `ns-3.35/scratch/mw-link-metrics.cc` — deterministic metrics calculator.

## Next Steps
1. Feed jitter/burst models from ns-3 into the middleware alongside mean delay.
2. Extend `mw-link-metrics` so horizontal distance or RSSI also influence the channel.
3. Package everything into a single launch script (PX4 + MAVROS + middleware + ns-3) for CI reproducibility.

## Testing
- Manual flight tests plus MAVROS/ns-3 sweeps as described above.
