# UAV Network Simulator Progress — 2024-10-07

## Context
- Initial focus: establish baseline PX4 SITL ↔ QGroundControl (QGC) connectivity.
- Current scope: drone flight simulator only; network effects (latency, loss, attacks, congestion) not yet modeled.
- Goal: evolve toward a UAV network simulator by adding three network-centric layers (to be defined in later updates).

## SITL vs. HITL Overview
<img width="1425" height="848" alt="image" src="https://github.com/user-attachments/assets/e5efc9a8-0334-489d-8006-3843892e176f" />

### SITL (Software in the Loop)
- Runs PX4 firmware purely in software without physical flight controller hardware.
- All components (PX4, Gazebo/jMAVSim, QGC, MAVROS, MAVSDK, etc.) communicate locally over UDP/TCP inside the host PC.
- Key modules:
  - `mavlink_main.cpp`: generates and processes MAVLink messages within PX4 and exposes multiple communication ports.
  - `simulator_mavlink.cpp`: bridges PX4 and external simulators, exchanging actuator commands and simulated sensor data.
- Supports simultaneous connections from GCS, simulators, and offboard APIs.

  
<img width="1386" height="809" alt="image" src="https://github.com/user-attachments/assets/23698a57-be42-48d3-8998-1d7072533f10" />

### HITL (Hardware in the Loop)
- Uses a physical PX4 controller (e.g., Pixhawk) connected to a simulator via USB serial.
- Components:
  - Hardware PX4 flight controller executing the firmware.
  - Simulator (Gazebo/jMAVSim) providing virtual sensors and receiving commands.
  - QGC/GCS connected via USB or UDP for monitoring and control.
- PX4 hardware runs in real time, while the simulator supplies virtualized sensors and environment.
- Communication centers around the USB serial link, with GCS/offboard APIs on UDP.

## Limitations of Baseline PX4 SITL Setup
- Provides:
  - Flight control logic via PX4 (`mavlink_main.cpp`).
  - Sensor/physics emulation through Gazebo or jMAVSim.
  - MAVLink command/telemetry (UDP ports 14540–14550) enabling direct communication with QGC, MAVROS, MAVSDK, etc.
- Assumes an ideal LAN (zero latency, zero packet loss), so it is merely a single-drone flight simulator, not a UAV **network** simulator.
- Missing network-layer elements such as latency, packet loss, attacks, and congestion modeling.

## Milestone — Primary Goal (Completed)
- MAVLink telemetry produced by PX4 SITL continuously streams into QGC and can also be consumed by MAVROS as needed.

## Execution Log
### PX4 SITL Launch
```bash
cd ~/PX4-Autopilot
# Dependency fix during setup
sed -i 's/matplotlib>=3\.0\.*/matplotlib>=3.0/' Tools/setup/requirements.txt
python3 -m pip install -r Tools/setup/requirements.txt
# Run SITL (examples: none_iris or gazebo)
PX4_NO_FORK=1 make px4_sitl_default none_iris
# If duplicate instance error occurs:
pkill -f 'px4_sitl_default/bin/px4' && PX4_NO_FORK=1 make px4_sitl_default none_iris
```

### ROS + MAVROS (No Launch File)
1. Terminal A
   ```bash
   source /opt/ros/noetic/setup.bash
   roscore
   ```
2. Terminal B
   ```bash
   source /opt/ros/noetic/setup.bash
   rosrun mavros mavros_node _fcu_url:=udp://:14540@
   ```
3. Connection check
   ```bash
   source /opt/ros/noetic/setup.bash
   rostopic echo -n1 /mavros/state
   # Expected: connected: True, guided: True, mode: "AUTO.LOITER"
   ```

### QGroundControl (Flatpak)
- Launch: `flatpak run org.mavlink.qgroundcontrol &`
- Connection setup (choose one):
  - **Method A (recommended):** Settings → Comm Links → Add → UDP → Listen on port `14550` → Connect.
  - **Method B:** Settings → Comm Links → Add → UDP → *Connect to a host* checked → Host `127.0.0.1`, Port `14540` → Connect.

### Data Flow Verification
- QGC: Analyze → MAVLink Inspector → confirms telemetry (e.g., `ATTITUDE` at 50 Hz).
- PX4 console: `pxh> mavlink status`
  - `instance #0`: UDP (`18570` → `14550`) — SITL → QGC telemetry.
  - `instance #1`: UDP (`14580` → `14540`, partner `127.0.0.1`) — SITL ↔ MAVROS link.
- Packet capture: `sudo tcpdump -ni lo 'udp port 14540 or udp port 14550'` (ignore `[bad udp cksum]` on loopback).

### MAVROS Integration Notes
- Additional telemetry (e.g., `Satellite_used`, `eph`, `epv`) forwarded via MAVROS in ROS Noetic.
- ROS distro: `noetic`; `rosversion mavros` → `1.20.1`.

### QGC Telemetry Logging
1. Enable: QGC → Settings → MAVLink (or General) → check **Save telemetry log after each flight**.
2. Flatpak log path: `~/.var/app/org.mavlink.qgroundcontrol/data/QGroundControl/Telemetry/`.
3. Post-processing example:
   ```bash
   pip3 install --user pymavlink
   mavlogdump.py --types ATTITUDE,GLOBAL_POSITION_INT --format csv \
     ~/.var/app/org.mavlink.qgroundcontrol/data/QGroundControl/Telemetry/xxx.tlog > out.csv
   ```

### Ports and Links
- PX4 UDP server (receive): `14540` ← MAVROS / QGC (Method B) connect here.
- PX4 → QGC telemetry: `14550` → QGC listens here (Method A).
- Verified via `mavlink status`:
  - `(18570 → 14550)` — SITL → QGC.
  - `(14580 → 14540)` — SITL ↔ MAVROS.

### Environment Summary
- OS: Ubuntu 20.04 (Focal) on ARM64 (aarch64) → requires Flatpak QGC (AppImage unavailable).
- ROS: Noetic installed.
- PX4: PX4-Autopilot SITL.

### Issues & Resolutions
| Issue | Resolution |
| --- | --- |
| QGC AppImage `Exec format error` on ARM64 | Use Flatpak QGC instead. |
| No `mavros.launch` | Launch MAVROS directly: `rosrun mavros mavros_node _fcu_url:=udp://:14540@`. |
| `Unable to communicate with master!` | Start `roscore` first. |
| SITL already running | `pkill -f 'px4_sitl_default/bin/px4'` before relaunching. |
| `[bad udp cksum]` in `tcpdump` | Expected on loopback; ignore. |

### Observed Outputs
- QGC MAVLink Inspector: `ATTITUDE 50.0 Hz` updating (screenshot referenced in original notes).
- `rostopic echo -n1 /mavros/state`: `connected: True`.
- `pxh> mavlink status`: confirms UDP instances listed above.

## Next Steps (Not Yet Implemented)
- Add explicit network-layer simulation (latency, loss, attacks, congestion) to transform the flight simulator into a UAV network simulator.
- Define additional layers required for true network simulation.
