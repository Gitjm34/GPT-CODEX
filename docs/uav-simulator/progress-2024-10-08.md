Proposed Markdown Content
# UAV Network Simulator Progress — 2024-10-08 (Middleware Build)

## Goal
Create a middleware layer that emulates real-world wireless links between QGroundControl (QGC) and PX4 SITL so that packet delay, loss, and throughput constraints can be applied before ns-3 is fully integrated.

QGC (UDP 14640) → [Middleware] → PX4 (UDP 14540)
PX4 (UDP 14550) → [Middleware] → QGC (default listen port)


- Both uplink (commands) and downlink (telemetry) must traverse a single simulated wireless hop.
- The middleware enforces latency, drop rate, and bandwidth caps derived from ns-3; it falls back to defaults (20 ms delay, 0 % loss, 5 Mbps rate) when ns-3 data is unavailable.

---

## Real-World Reference Architecture
| Element | Role |
| --- | --- |
| Ground Control Station (GCS/QGC) | Issues commands and receives telemetry. |
| Wireless link (Wi-Fi/LTE/Mesh) | Bidirectional medium introducing latency, jitter, loss, and rate limits. |
| UAV (PX4 SITL) | Executes flight control, emits telemetry, and accepts uplink commands. |

**Key insight:** every command and telemetry packet should cross the wireless link exactly once in each direction. The middleware emulates this behavior so the pure-software SITL stack experiences realistic network impairments.

---

## Why a Middleware Layer Is Needed
- ns-3 does not run PX4 or QGC; it only simulates network behavior.
- To expose PX4/QGC traffic to ns-3, a “man-in-the-middle” UDP relay (`udp_mw_ns3.py`) captures packets, feeds them through ns-3-derived metrics, and forwards them transparently.
- Once ns-3 integration is active, the middleware queries ns-3 for current delay/loss/rate figures; otherwise it uses the baseline defaults.

---

## Port Layout
| Component | Direction | Port | Notes |
| --- | --- | --- | --- |
| PX4 SITL | RX | 14540 | Original command server; middleware forwards QGC uplink here. |
| PX4 SITL | TX | 14550 | Telemetry source; middleware listens on the same port to intercept downlink traffic. |
| Middleware | RX (from QGC) | 14640 | QGC connects here via “Connect to host”. |
| Middleware | RX (from PX4) | 14550 | Matches PX4 telemetry port to capture packets. |
| Middleware | TX (to PX4) | 14540 | Sends delayed/dropped/limited packets onward. |
| Middleware | TX (to QGC) | QGC’s listen port (default 14550) | Delivers processed telemetry. |

Result: QGC and PX4 both “feel” as though they are directly connected, but every packet is filtered through the middleware first.

---

## Middleware Behavior (`udp_mw_ns3.py`)
1. **Uplink (QGC → PX4)**
   - QGC sends MAVLink commands to UDP 14640.
   - Middleware timestamps and queues the packet, applies delay/loss/throughput shaping, then forwards to PX4’s UDP 14540 server.

2. **Downlink (PX4 → QGC)**
   - Middleware listens on UDP 14550 to intercept PX4 telemetry.
   - The same impairment logic is applied before packets are forwarded to QGC’s listening socket.

3. **Impairment Parameters**
   - Defaults: 20 ms latency, 0 % loss, 5 Mbps throughput—allows immediate testing even without ns-3.
   - When ns-3 is compiled and running, middleware pulls real metrics (e.g., via shared memory or IPC) so live channel conditions are reflected automatically.

4. **Execution**
   ```bash
   python3 ~/mw_ns3/udp_mw_ns3.py
The script remains in the path until ns-3 hands over control.
<img width="1444" height="944" alt="image" src="https://github.com/user-attachments/assets/9772cc13-fec1-4bc8-b3da-f5fdae9d8bbb" />


Verification & Observations
Before middleware: uplink/downlink counters stay at zero because packets bypass the simulator.

After middleware insertion:

Uplink traffic stabilizes around 107–168 B/s (only heartbeat/parameter requests from QGC).

Downlink traffic sits near 5–6 KB/s because PX4 streams high-rate telemetry (e.g., ATTITUDE at 50 Hz).

Confirms both command and telemetry flows are traversing the relay and receiving impairment parameters.

Next Steps
Tight ns-3 Integration

Finalize IPC between ns-3 and the middleware so delay/loss/bandwidth numbers update continuously.

Extended Metrics

Add jitter distributions, burst-loss models, and rate shaping per direction.

Automation

Provide scripts to launch PX4 SITL, middleware, ns-3, and QGC in a single workflow to reduce manual wiring.

Monitoring

Enhance terminal dashboards to log per-flow throughput and packet counts for quick regression checks.


## Testing
- Not run (not requested).

