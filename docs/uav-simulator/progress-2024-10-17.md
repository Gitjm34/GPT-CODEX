# UAV Network Simulator Progress — 2024-10-17 (HTTP Collector Build)

## Objective
- Extend the 10/08–10/09 middleware + ns-3 stack with a push/pull telemetry service so AI/RL agents can consume live network and flight observations.
- Middleware still shapes QGC ↔ PX4 traffic every second, but now it POSTs delay/loss/rate/up/down metrics to an HTTP collector, while a ROS helper sends altitude/velocity/GNSS extras to the same server.
- Downstream systems query `/obs/latest` or `/obs/seq` to pull a synchronized time series that blends both network and flight context.

## Components Added/Updated
| File | Role |
| --- | --- |
| `collector.py` | FastAPI + Uvicorn service that stores `/ingest` (network) and `/ingest_extra` (flight) payloads in memory and serves them via `/obs/latest`, `/obs/extra/latest`, and `/obs/seq`. |
| `mw_ns3/udp_mw_ns3.py` | Middleware now tags every 1 Hz record with `run_id`, `seq`, and `node_id`, keeps writing `~/.uav_ids/flow.jsonl`, and optionally pushes each record to `IDS_ENDPOINT` via HTTP. |
| `mw_ns3/mw_ns3/start_mw.sh` | Launch helper now wires optional `RUN_ID`, `IDS_ENDPOINT`, and `IDS_TIMEOUT` arguments when invoking the middleware. |
| `mw_ns3/mw_ns3/start_alt.sh` | Wrapper that sources ROS, exports `NS3_PATH`, and launches `alt2positions.py` so altitude keeps feeding ns-3 at 1 Hz. |
| `mw_ns3/ros_extra_pusher.py` | ROS node that reads MAVROS topics (`rel_alt`, `velocity_local`, `compass_hdg`, `state`, `battery`, GNSS, `/mavlink/from`) and POSTs derived extras (altitude, groundspeed, heading, GNSS quality, heartbeat gaps, message Hz) to `/ingest_extra`. |

## HTTP Collector API (`collector.py`)
1. Install dependencies once:
   ```bash
   sudo apt-get update
   sudo apt-get install -y python3-pip
   python3 -m pip install --user fastapi uvicorn pydantic requests
   ```
2. Launch the collector (defaults to `0.0.0.0:8080`):
   ```bash
   python3 ~/collector.py
   ```

### Endpoints
| Method & Path | Description |
| --- | --- |
| `POST /ingest` | Middleware sends `{run_id, ts, up_bytes, down_bytes, delay_ms, loss_pct, rate_kbps, node_id?, seq?}`. Server auto-increments `seq` per `run_id` and merges any recent extra fields. |
| `POST /ingest_extra` | ROS helper sends `{run_id, ts, altitude_m, groundspeed_mps, battery_pct, heading_deg, heartbeat_gap_ms, fix_type, eph/epv, satellites_used, jamming_indicator, hb_hz, status_hz, paramset_hz, cmdlong_hz, gpsint_hz, node_id}`. Server caches the most recent extra per `run_id` for merging. |
| `GET /obs/latest?k=N` | Returns the newest `N` merged `/ingest` records (default `k=1`, max `k=1000`). |
| `GET /obs/extra/latest?k=N` | Returns the newest `N` raw `/ingest_extra` records for debugging. |
| `GET /obs/seq?since_seq=x&limit=y&run_id=<id>` | Streams records for one `run_id` starting at `since_seq` (defaults to the newest run if not provided). Useful for polling agents.

Example merged record (from `/obs/latest?k=1`):
```json
{
  "run_id": "nhn-demo-01",
  "seq": 221,
  "ts": 1760545607.558,
  "node_id": "ubuntu",
  "up_bytes": 112,
  "down_bytes": 3751,
  "delay_ms": 11.67,
  "loss_pct": 0.501,
  "rate_kbps": 5933.2,
  "altitude_m": 0.04,
  "groundspeed_mps": 0.05,
  "battery_pct": 100.0,
  "heading_deg": 89.0,
  "heartbeat_gap_ms": 1000.3,
  "fix_type": 3,
  "satellites_used": 12,
  "hb_hz": 1.0,
  "status_hz": 5.0,
  "paramset_hz": 0.0,
  "cmdlong_hz": 0.0,
  "gpsint_hz": 5.0
}
```

## End-to-End Bring-up (Minimum Sequence)
1. **Collector**
   ```bash
   pkill -f collector.py 2>/dev/null || true
   python3 ~/collector.py &
   ```
2. **PX4 SITL**
   ```bash
   cd ~/PX4-Autopilot
   make px4_sitl gazebo    # leave pxh> running
   ```
3. **ROS + MAVROS + altitude mirroring**
   ```bash
   source /opt/ros/noetic/setup.bash
   roscore &   # skip if already running
   roslaunch mavros px4.launch fcu_url:="udp://:14540@"
   export NS3_PATH="$HOME/ns-allinone-3.35/ns-3.35"
   ~/mw_ns3/start_alt.sh   # wraps alt2positions.py at 1 Hz
   ```
4. **Middleware (HTTP push enabled)**
   ```bash
   export IDS_ENDPOINT="http://127.0.0.1:8080/ingest"
   export RUN_ID="run_$(date +%y%m%d_%H%M)"
   export NS3_PATH="$HOME/ns-allinone-3.35/ns-3.35"
   ~/mw_ns3/start_mw.sh
   ```
   Console should show `[MW] run_id=…` plus `[NS3]… delay=… loss=… rate=…` and `[IDS]` success logs.
5. **ROS extra pusher (telemetry → `/ingest_extra`)**
   ```bash
   export IDS_EXTRA_ENDPOINT="http://127.0.0.1:8080/ingest_extra"
   export RUN_ID  # same as middleware!
   python3 ~/mw_ns3/ros_extra_pusher.py &
   ```
6. **QGroundControl wiring**
   - Disable UDP auto-listen on 14550.
   - `Connect to host → 127.0.0.1:14640` (MW uplink). A temporary entry toward `127.0.0.1:18570` can help PX4 learn the partner.

7. **Verify data pull**
   ```bash
   curl -s "http://127.0.0.1:8080/obs/latest?k=3" | python3 -m json.tool
   curl -s "http://127.0.0.1:8080/obs/seq?since_seq=100&limit=5" | python3 -m json.tool
   ```
   Matching timestamps and `run_id` across network + extra fields confirms that push (middleware, ROS) and pull (collector) are wired correctly.

## Observations & Tests
- **POST monitoring**: the collector terminal prints `POST /ingest 200 OK` and `/ingest_extra` every second when both producers are running.
- **Middleware log**: still records `~/.uav_ids/flow.jsonl` for offline analysis while also pushing the same payloads over HTTP.
- **Altitude-driven scenarios**: raising PX4 to 5 m / 30 m / 80 m / ≥150 m yields ≈15/40/90/160 ms delays respectively, and the posted JSON reflects those values along with telemetry fields.
- **Blackout test**: writing `0 0 333` into `positions.txt` (or letting ROS helper do so) yields ≈100 % loss for ~2 s. `/obs/latest` shows `loss_pct` spikes and `down_bytes` drop before recovering.

## Data Schema (per record)
| Field | Source | Notes |
| --- | --- | --- |
| `run_id` | Env/CLI | Session tag; set once and reuse across middleware + ROS helpers. |
| `seq` | Collector | Per-`run_id` monotonic counter. |
| `ts` | Middleware | Epoch seconds when the record was generated. |
| `node_id` | Middleware/ROS hostname | Allows multi-node deployments. |
| `up_bytes` / `down_bytes` | Middleware | Bytes relayed during the previous 1 s window. |
| `delay_ms` / `loss_pct` / `rate_kbps` | ns-3 via middleware | Reflects the currently enforced link model. |
| `altitude_m`, `groundspeed_mps`, `heading_deg`, `battery_pct`, `heartbeat_gap_ms` | ROS extras | Derived from MAVROS state, velocity, compass, and battery topics. |
| `fix_type`, `satellites_used`, `eph`, `epv`, `jamming_indicator` | ROS extras | GNSS quality indicators (raw GPS → NavSatFix fallback). |
| `hb_hz`, `status_hz`, `paramset_hz`, `cmdlong_hz`, `gpsint_hz` | ROS extras | Computed from `/mavlink/from` message counts to detect spam/DoS conditions. |

## Troubleshooting
- **FastAPI import errors** → ensure `python3 -m pip install --user fastapi uvicorn pydantic requests` was executed.
- **MAVROS not connected** → launch with `fcu_url:=udp://:14540@` and confirm `/mavros/state` reports `connected: True`.
- **`positions.txt` keeps reverting** → stop `start_alt.sh` (it writes at 1 Hz) before manual edits.
- **Collector returns empty arrays** → verify both `RUN_ID` and endpoints match (`IDS_ENDPOINT`, `IDS_EXTRA_ENDPOINT`).
- **QGC disconnects** → ensure only one middleware instance is bound to 14640/14550 and QGC uses `Port=0`, `Server=127.0.0.1:14640`.

## Next Steps
1. Harden the collector (persistence, auth, retention, pagination) for long training runs.
2. Expose jitter/burst stats from ns-3 so the middleware can push richer observability.
3. Package the bring-up steps (PX4 + MAVROS + middleware + collectors) into a single tmux/supervisor script for CI and teammates.
4. Connect the NHN RL agent so it polls `/obs/seq` in real time and correlates rewards with network conditions.

## Testing
- Manual verification via PX4 SITL + MAVROS + middleware, curl checks for `/obs/latest` and `/obs/seq`, and confirmation that POST streams hit the FastAPI console.
